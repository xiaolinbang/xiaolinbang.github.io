# ceph集群高可用机制

## mon分布式集群

#### 实现方式

	Paxos算法；

	
	
	主mon周期性给所有在quorum中的mon发送LEASE租赁消息（mon之间的心跳保活复用了此机制）；

	主mon在发送给某个从mon发送LEASE消息后，超过一定时间未收到此从mon的应答消息，则认为此从mon异常，重新发起选举过程；

	从mon在等待一定时间后，未收到主mon发送过来的LEASE消息，则认为主mon异常，重新发起选举过程；

#### 常见场景（3节点环境）

1. 某个从mon宕机、或者跟其他两个节点网络不通；（从mon异常）

2. 主mon宕机、或者跟其他两个节点网络不通；（主mon异常）

3. 一个异常节点重新恢复正常；

4. 新增一个节点；

5. 删除一个节点；

#### 异常

1. 如果不存在一半以上的节点组成一个quorum集合，则无法选出主mon，无法对外提供服务；（如：3节点集群只支持两个节点异常）

2. 节点之间时间不同步，偏差较大时，会导致重新选举；


## mds服务的高可用（主备模式）

#### 实现方式

- 每个mds服务周期性向mon集群发送心跳消息（默认时间为4s）；

- mon进程周期性检查是否收到mds的心跳消息，如超过一定时间（默认为15s）未收到心跳消息，则认为mds异常；

- 如果检测到主mds异常，且当前有可用的备mds，则从备mds中选择一个成为主mds提供服务；

- 备mds周期性从主mds读取其元数据日志，把最新数据同步到本机的内存中；

### 实际场景样例

- 主mds宕机、或网络异常时；

- mon集群无主，选举失败时；

- 网络分区；


## mgr服务的高可用（主备模式）

#### 实现方式

- mgr启动后默认以备mgr模式运行；
- 每个mgr周期性向mon集群发送心跳消息；
- mgr向mon集群订阅MgrMap信息；（mon维护的MgrMap信息变更时，将向mgr发送新的MgrMap信息）
- mon收到心跳信息后，更新最后一次收到心跳消息的时间；
- 主mon周期性检查每一个mgr最后一次发送过来的心跳的间隔时长是否超过一定阀值，如超过，则以为此mgr异常；如是主mgr异常，则从可用的备mgr选择一个成为主；如是备mgr异常，则把此mgr从备选的mgr中移除；最后更新MgrMap信息；
- 当mgr收到MgrMap信息后，检查mon集群发送过来的主mgr是否是自己，如是，则切换成主mgr模式；
- mgr的选举策略是按加入到mon的顺利，选举加入时间早的mgr节点作为主mgr；

### 常见场景（双mgr部署环境下）

- 某个mgr宕机、或网络异常；

	如果是从mgr异常，无需处理，继续提供服务即可；
	如果是主mgr异常，从存活的从mgr中选择一个新的mgr，继续提供服务；

- 新增一个mgr节点；

	如果目前没有主mgr，则其成为主mgr；
	如当前已经有主mgr，其加入到可选的备mgr列表中；

- mon集群无主，选举失败时；

	xxx
